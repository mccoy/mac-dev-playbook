---
- name: Determine if file exists for quarantine check
  stat:
    path: "{{ item }}"
  register: file_check

- name: Determine if file is in quarantine
  shell: "xattr -l {{ item }} | cut -f 1 -d ' ' | grep quarantine"
  register: quarantine_check
  failed_when: quarantine_check.rc == 2
  when: file_check.stat.exists

- name: Release file from quarantine
  command: "xattr -cr {{ item }}"
  when: quarantine_check.rc == 1

- name: Restart qlmanage
  shell: "qlmanage -r ; qlmanage -r cache"
  when: quarantine_check.rc == 1 and {{ item }}.endswith('qlgenerator')"
